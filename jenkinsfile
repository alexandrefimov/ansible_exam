node("jenkins-slave")  {
    cleanWs()
    def AWS_ACCESS_KEY_ID = credentials('aws-key-id')
    def AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')

    stage('Upload Ansible Repo') {
        git credentialsId: 'ssh-git-key', url: 'git@github.com:alexandrefimov/ansible_exam.git'
    }
    stage('Install Galaxy Roles') {
        sh 'ansible-galaxy install alexandrefimov.docker_role, alexandrefimov.web_role, alexandrefimov.nginx_role --force'
    }
    stage('Install Amazon Plugin') {
        sh 'ansible-galaxy collection install amazon.aws'
    }
    stage('Deploy Calc App') {
        ansiblePlaybook credentialsId: 'aws-ssh-key', inventory: 'inventory', playbook: 'playbook.yml', vaultCredentialsId: 'vault'
    }
    stage('Integration Test') {
        def test = httpRequest 'http://54.246.50.201'
        println("Server status: "+test.status)
    }
}

