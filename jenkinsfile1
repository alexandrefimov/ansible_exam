node("jenkins-slave")  {
    cleanWs()
    stage('Upload Ansible Repo') {
        git credentialsId: 'ssh-git-key', url: 'git@github.com:alexandrefimov/ansible_exam.git'
    }
    stage('Install Amazon Plugin') {
        sh 'ansible-galaxy collection install amazon.aws'
    }
    stage('Import EC2 read cred') {
        withCredentials([string(credentialsId: 'aws-key-id', variable: 'keyid')]) {
            sh "export AWS_ACCESS_KEY_ID='$keyid'"
        }
    }
    stage('Import EC2 read cred 2') {
        withCredentials([string(credentialsId: 'aws-secret-key', variable: 'ackey')]) {
            sh "export AWS_SECRET_ACCESS_KEY='$ackey'"
        }
    }
    stage('Deploy Calc App') {
        ansiblePlaybook credentialsId: 'aws-ssh-key', inventory: 'aws_ec2.yml', playbook: 'playbook1.yml', vaultCredentialsId: 'vault'
    }
}

