node("jenkins-slave")  {
    cleanWs()
    def keyid = credentials('aws-key-id')
    def ackey = credentials('aws-secret-key')

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')
    }
    stage('Upload Ansible Repo') {
        git credentialsId: 'ssh-git-key', url: 'git@github.com:alexandrefimov/ansible_exam.git'
    }
    stage('Configure AWS') {
        sh "aws configure set aws_access_key_id '$keyid' && aws configure set aws_secret_access_key '$ackey'"
    }
    stage('Deploy Calc App') {
        ansiblePlaybook credentialsId: 'aws-ssh-key', inventory: 'aws_ec2.yml', playbook: 'playbook1.yml', vaultCredentialsId: 'vault'
    }
}

